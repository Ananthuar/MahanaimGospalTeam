<!-- admin/firestore_admin.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mahanaim Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    /* small local mod to tighten admin layout */
    body{background:linear-gradient(180deg,#041021,#071322)}
    header{padding:1rem 0}
    .admin-grid{display:grid;grid-template-columns:1fr 380px;gap:1rem}
    .admin-card{padding:1rem;border-radius:12px}
    .btn-small{padding:.45rem .6rem;border-radius:8px}
    .danger{background:linear-gradient(90deg,#ff7a7a,#ff4a4a);color:#fff;border:none}
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a class="brand" href="../index.html"><div class="logo-wrap" aria-hidden="true"></div><div class="brand-text">Mahanaim Admin</div></a>
      <div>
        <button id="btn-signin" class="btn btn-small">Sign in with Google</button>
        <button id="btn-signout" class="btn btn-small" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="admin-grid">
      <div class="admin-card card admin-card">
        <h2>Manage Events</h2>
        <form id="event-form">
          <input type="hidden" id="event-id" value="">
          <label>Title<input id="ev-title" required></label>
          <label>Date (YYYY-MM-DD)<input id="ev-date" required placeholder="2025-12-06"></label>
          <label>Display Date (optional)<input id="ev-displayDate"></label>
          <label>Place<input id="ev-place"></label>
          <label>Description<textarea id="ev-desc" rows="3"></textarea></label>
          <div style="display:flex;gap:.6rem;margin-top:.6rem">
            <button id="btn-save" class="btn">Save Event</button>
            <button id="btn-reset" class="btn secondary" type="button">Reset</button>
          </div>
        </form>
        <div id="status" class="tiny muted" style="margin-top:.6rem">Not signed in</div>
      </div>

      <aside class="admin-card card admin-card">
        <h3 class="tiny muted">Events</h3>
        <div id="events-wrap" class="muted tiny">Loading…</div>
      </aside>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script src="../assets/js/firebase-config.js"></script>

  <script>
    if (!window.FIREBASE_CONFIG) {
      document.getElementById('status').textContent = 'Add assets/js/firebase-config.js with your Firebase config.';
      throw new Error('FIREBASE_CONFIG missing');
    }

    firebase.initializeApp(window.FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const btnSignIn = document.getElementById('btn-signin');
    const btnSignOut = document.getElementById('btn-signout');
    const statusEl = document.getElementById('status');
    const eventsWrap = document.getElementById('events-wrap');
    const form = document.getElementById('event-form');
    const evId = document.getElementById('event-id');
    const evTitle = document.getElementById('ev-title');
    const evDate = document.getElementById('ev-date');
    const evDisplay = document.getElementById('ev-displayDate');
    const evPlace = document.getElementById('ev-place');
    const evDesc = document.getElementById('ev-desc');

    let currentUser = null;
    let isAdmin = false;

    btnSignIn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => statusEl.textContent = 'Sign-in error: ' + err.message);
    };
    btnSignOut.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        const token = await user.getIdTokenResult(true);
        isAdmin = !!token.claims.admin;
        statusEl.textContent = 'Signed in as ' + user.email + (isAdmin ? ' (admin)' : ' (no admin)');
        btnSignIn.style.display = 'none';
        btnSignOut.style.display = 'inline-block';
      } else {
        statusEl.textContent = 'Not signed in';
        btnSignIn.style.display = 'inline-block';
        btnSignOut.style.display = 'none';
        isAdmin = false;
      }
      loadEvents();
    });

    async function loadEvents() {
      eventsWrap.innerHTML = 'Loading…';
      try {
        const snap = await db.collection('events').orderBy('date','asc').get();
        const items = [];
        snap.forEach(d => items.push({ id: d.id, ...d.data() }));
        if (items.length === 0) eventsWrap.innerHTML = '<div class="muted tiny">No events yet.</div>';
        else {
          const rows = items.map(it => `<div style="display:flex;justify-content:space-between;gap:.5rem;padding:.35rem 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div><strong>${escapeHtml(it.title)}</strong><div class="tiny muted">${escapeHtml(it.displayDate || it.date)}</div></div><div style="display:flex;gap:.4rem"><button data-id="${it.id}" class="btn-small" onclick="editEvent('${it.id}')">Edit</button><button onclick="deleteEvent('${it.id}')" class="btn-small danger">Delete</button></div></div>`).join('');
          eventsWrap.innerHTML = rows;
        }
      } catch (err) {
        eventsWrap.innerHTML = '<div class="tiny muted">Unable to load events: ' + escapeHtml(err.message) + '</div>';
      }
    }

    window.editEvent = async (id) => {
      try {
        const doc = await db.collection('events').doc(id).get();
        if (!doc.exists) return alert('Event not found');
        const d = doc.data();
        evId.value = id; evTitle.value = d.title || ''; evDate.value = d.date || ''; evDisplay.value = d.displayDate || ''; evPlace.value = d.place || ''; evDesc.value = d.description || '';
        window.scrollTo({top:0,behavior:'smooth'});
      } catch (err) { statusEl.textContent = 'Error loading event'; }
    };

    window.deleteEvent = async (id) => {
      if (!confirm('Delete this event?')) return;
      try {
        await db.collection('events').doc(id).delete();
        loadEvents();
      } catch (err) {
        statusEl.textContent = 'Delete failed: ' + err.message;
      }
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('Sign in first');
      if (!isAdmin) return alert('You must be an admin to save');

      const payload = { title: evTitle.value.trim(), date: evDate.value.trim(), displayDate: evDisplay.value.trim(), place: evPlace.value.trim(), description: evDesc.value.trim() };
      try {
        if (evId.value) await db.collection('events').doc(evId.value).set(payload, {merge:true});
        else await db.collection('events').add(payload);
        evId.value=''; form.reset(); loadEvents();
      } catch (err) {
        statusEl.textContent = 'Save failed: ' + err.message;
      }
    };

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  </script>
</body>
</html>
